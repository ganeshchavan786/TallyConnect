<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Register - TallyConnect</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/utilities.css">
    <link rel="stylesheet" href="assets/css/ledger-report.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="brand">
                <img class="brand-logo" src="/logo.png" alt="Logo" onerror="this.style.display='none'">
                <div>
                    <div class="brand-title">TallyConnect</div>
                    <div class="brand-subtitle">Report Portal</div>
                </div>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link" href="companies.html">ğŸ¢ Companies</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="dashboard.html">ğŸ“ˆ Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="outstanding-report.html">ğŸ“Š Outstanding</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="ledgers.html">ğŸ“— Ledger</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="sales-register.html">ğŸ’° Sales Register</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="finance.html">ğŸ’¼ Finance</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sync-logs.html">ğŸ“‹ Sync Logs</a>
            </li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page active" style="position: relative;">
            <h1 class="page-title">Sales Register</h1>
            <p class="page-subtitle">Monthly sales summary and voucher details</p>
            
            <!-- Period Selection Controls -->
            <div id="periodControls" class="tc-panel tc-mb-20" style="display: none;">
                <div class="controls-row">
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="fromDate" style="display: block; margin-bottom: 5px; color: var(--muted); font-weight: 600; font-size: 12px;">From Date</label>
                        <input type="date" id="fromDate" class="filter-select" style="width: 100%; padding: 8px 12px;">
                    </div>
                    <div class="form-group" style="flex: 1; min-width: 200px;">
                        <label for="toDate" style="display: block; margin-bottom: 5px; color: var(--muted); font-weight: 600; font-size: 12px;">To Date</label>
                        <input type="date" id="toDate" class="filter-select" style="width: 100%; padding: 8px 12px;">
                    </div>
                    <div class="form-group" style="display: flex; align-items: flex-end; gap: 10px;">
                        <button id="applyPeriodBtn" class="tc-btn tc-btn--primary" style="padding: 8px 20px;">
                            Apply Period
                        </button>
                    </div>
                </div>
                
                <!-- View Toggle -->
                <div class="controls-row" style="margin-top: 12px; align-items: center;">
                    <label style="font-weight: 600; color: var(--muted); font-size: 12px; margin-right: 10px;">View:</label>
                    <button id="viewMonthly" class="tc-btn" style="padding: 6px 16px; font-size: 12px; background: rgba(37, 99, 235, 0.1); color: rgba(37, 99, 235, 0.9); border: 1px solid rgba(37, 99, 235, 0.3);">
                        Monthly Summary
                    </button>
                    <button id="viewVouchers" class="tc-btn" style="padding: 6px 16px; font-size: 12px; background: rgba(91, 107, 127, 0.1); color: rgba(91, 107, 127, 0.9); border: 1px solid rgba(91, 107, 127, 0.3);">
                        Voucher List
                    </button>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="tc-error" style="display: none;"></div>

            <!-- Loading Indicator -->
            <div id="loadingMessage" class="tc-loading" style="display: none;">
                <div class="spinner" style="margin: 20px auto;"></div>
                <div class="tc-loading__text">Loading sales register...</div>
            </div>

            <!-- Empty State -->
            <div id="emptyMessage" class="tc-empty-state" style="display: none;">
                <div class="tc-empty-state__icon">ğŸ’°</div>
                <div class="tc-empty-state__title">No Sales Data Found</div>
                <div class="tc-empty-state__text">No sales transactions found for the selected period.</div>
            </div>
            
            <div id="reportContent" class="report-viewer">
                <div class="tc-loading">
                    <div class="spinner" style="margin: 20px auto;"></div>
                    <div class="tc-loading__text">Loading sales register...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Files -->
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/export.js"></script>
    <script src="assets/js/utils/filters.js"></script>
    <script src="assets/js/utils/report-service.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/components/companies.js"></script>
    <script src="assets/js/components/ledgers.js"></script>
    <script src="assets/js/components/sales-register.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        // Global variables
        let currentCompany = null;
        let currentView = 'monthly'; // 'monthly' or 'vouchers'
        let salesRegisterData = null;
        
        // Store in window for global access
        if (typeof window !== 'undefined') {
            window.currentView = 'monthly';
        }
        
        // Format date from YYYY-MM-DD to DD-MM-YYYY for API
        function formatDateForAPI(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }
        
        // Load report with current period
        function loadReportWithPeriod() {
            if (!currentCompany) return;
            
            const fromDate = document.getElementById('fromDate').value;
            const toDate = document.getElementById('toDate').value;
            
            if (!fromDate || !toDate) {
                alert('Please select both From Date and To Date');
                return;
            }
            
            const fromDateFormatted = formatDateForAPI(fromDate);
            const toDateFormatted = formatDateForAPI(toDate);
            
            const safeGuid = currentCompany.guid.replace(/-/g, '_').replace(/\./g, '_');
            const safeAlterid = String(currentCompany.alterid).replace(/\./g, '_');
            const apiUrl = `api/sales-register-data/${safeGuid}_${safeAlterid}?from_date=${fromDate}&to_date=${toDate}`;
            
            loadSalesRegister(apiUrl, 'reports');
        }
        
        // Toggle view
        function toggleView(viewType) {
            currentView = viewType;
            if (typeof window !== 'undefined') {
                window.currentView = viewType;
            }
            
            // Update button styles
            const monthlyBtn = document.getElementById('viewMonthly');
            const vouchersBtn = document.getElementById('viewVouchers');
            if (monthlyBtn) {
                monthlyBtn.style.background = viewType === 'monthly' ? 'rgba(37, 99, 235, 0.2)' : 'rgba(91, 107, 127, 0.1)';
                monthlyBtn.style.color = viewType === 'monthly' ? 'rgba(37, 99, 235, 1)' : 'rgba(91, 107, 127, 0.9)';
                monthlyBtn.style.borderColor = viewType === 'monthly' ? 'rgba(37, 99, 235, 0.5)' : 'rgba(91, 107, 127, 0.3)';
            }
            if (vouchersBtn) {
                vouchersBtn.style.background = viewType === 'vouchers' ? 'rgba(37, 99, 235, 0.2)' : 'rgba(91, 107, 127, 0.1)';
                vouchersBtn.style.color = viewType === 'vouchers' ? 'rgba(37, 99, 235, 1)' : 'rgba(91, 107, 127, 0.9)';
                vouchersBtn.style.borderColor = viewType === 'vouchers' ? 'rgba(37, 99, 235, 0.5)' : 'rgba(91, 107, 127, 0.3)';
            }
            
            // Re-render with current data (use window.salesRegisterData if available)
            const data = window.salesRegisterData || salesRegisterData;
            if (data) {
                renderSalesRegister(data, currentView);
            } else {
                // Reload if data not available
                loadReportWithPeriod();
            }
        }
        
        // Load report from sessionStorage (override app.js window.onload)
        window.addEventListener('load', function() {
            const savedCompany = sessionStorage.getItem('selectedCompany');
            if (savedCompany) {
                currentCompany = JSON.parse(savedCompany);
                
                // Show period controls
                document.getElementById('periodControls').style.display = 'block';
                
                // Set default dates (Financial Year: April 1 to March 31)
                const today = new Date();
                const currentYear = today.getFullYear();
                let fromDate, toDate;
                
                if (today.getMonth() >= 3) { // April (3) to December
                    fromDate = `${currentYear}-04-01`;
                    toDate = `${currentYear + 1}-03-31`;
                } else { // January to March
                    fromDate = `${currentYear - 1}-04-01`;
                    toDate = `${currentYear}-03-31`;
                }
                
                document.getElementById('fromDate').value = fromDate;
                document.getElementById('toDate').value = toDate;
                
                // Load report with initial dates
                loadReportWithPeriod();
                
                // Add event listeners
                document.getElementById('applyPeriodBtn').addEventListener('click', loadReportWithPeriod);
                document.getElementById('viewMonthly').addEventListener('click', () => toggleView('monthly'));
                document.getElementById('viewVouchers').addEventListener('click', () => toggleView('vouchers'));
            } else {
                window.location.href = 'companies.html';
            }
        });
    </script>
</body>
</html>

