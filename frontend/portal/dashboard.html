<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - TallyConnect</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/utilities.css">
    <link rel="stylesheet" href="assets/css/ledger-report.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="brand">
                <img class="brand-logo" src="/logo.png" alt="Logo" onerror="this.style.display='none'">
                <div>
                    <div class="brand-title">TallyConnect</div>
                    <div class="brand-subtitle">Report Portal</div>
                </div>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link" href="companies.html">ğŸ¢ Companies</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="dashboard.html">ğŸ“ˆ Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="outstanding-report.html">ğŸ“Š Outstanding</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="ledgers.html">ğŸ“— Ledger</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sales-register.html">ğŸ’° Sales Register</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sync-logs.html">ğŸ“‹ Sync Logs</a>
            </li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page active">
            <a href="reports.html" class="back-button">â† Back to Reports</a>
            <div class="tc-dashboard-layout">
                <!-- Filters Panel -->
                <div class="tc-dashboard-filters">
                    <div id="filterContainer"></div>
                </div>
                <!-- Dashboard Content -->
                <div class="tc-dashboard-content">
                    <div id="reportContent" class="report-viewer">
                        <div class="tc-loading">
                            <div class="spinner" style="margin: 20px auto;"></div>
                            <div class="tc-loading__text">Loading dashboard...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart.js Library (Open Source) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- JavaScript Files -->
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/export.js"></script>
    <script src="assets/js/utils/filters.js"></script>
    <script src="assets/js/utils/date-filters.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/components/companies.js"></script>
    <script src="assets/js/components/ledgers.js"></script>
    <script src="assets/js/components/dashboard.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        // Global date filter manager
        let dashboardDateFilter = null;
        
        // Load report from sessionStorage (override app.js window.onload)
        window.addEventListener('load', function() {
            const savedCompany = sessionStorage.getItem('selectedCompany');
            if (savedCompany) {
                selectedCompany = JSON.parse(savedCompany);

                // If company name contains FY like "F.Y. 21-22", default dashboard to that FY
                let defaultFYStartYear = null;
                try {
                    const name = (selectedCompany && selectedCompany.name) ? String(selectedCompany.name) : '';
                    const m = name.match(/F\\.?Y\\.?\\s*(\\d{2})\\s*-\\s*(\\d{2})/i);
                    if (m) {
                        const yy = parseInt(m[1], 10);
                        defaultFYStartYear = 2000 + yy; // 21 => 2021
                    }
                } catch (e) {
                    defaultFYStartYear = null;
                }
                
                // Initialize date filter manager
                dashboardDateFilter = new DateFilterManager({
                    containerId: 'filterContainer',
                    defaultDateRange: 'current_financial_year',
                    defaultYear: defaultFYStartYear,
                    layout: 'panel',
                    onFilterChange: function(filterParams) {
                        // Reload dashboard with new filter parameters
                        reloadDashboardWithFilters(filterParams);
                    }
                });
                dashboardDateFilter.render();
                
                // Load dashboard with initial filters
                const filterParams = dashboardDateFilter.getFilterParams();
                loadDashboardReportWithFilters(filterParams);
            } else {
                window.location.href = 'companies.html';
            }
        });
        
        /**
         * Load dashboard with filter parameters
         */
        function loadDashboardReportWithFilters(filterParams) {
            const safeGuid = selectedCompany.guid.replace(/-/g, '_').replace(/\./g, '_');
            const safeAlterid = String(selectedCompany.alterid).replace(/\./g, '_');
            
            // Build API URL with query parameters
            const params = new URLSearchParams();
            if (filterParams.start_date) params.append('start_date', filterParams.start_date);
            if (filterParams.end_date) params.append('end_date', filterParams.end_date);
            if (filterParams.financial_year) params.append('financial_year', filterParams.financial_year);
            
            const queryString = params.toString();
            const apiUrl = `api/dashboard-data/${safeGuid}_${safeAlterid}${queryString ? '?' + queryString : ''}`;
            
            loadDashboardReport(apiUrl, 'reports');
        }
        
        /**
         * Reload dashboard when filters change
         */
        function reloadDashboardWithFilters(filterParams) {
            loadDashboardReportWithFilters(filterParams);
        }
    </script>
</body>
</html>

