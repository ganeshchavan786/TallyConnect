<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Dashboard - TallyConnect</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/utilities.css">
    <link rel="stylesheet" href="assets/css/ledger-report.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="brand">
                <img class="brand-logo" src="/logo.png" alt="Logo" onerror="this.style.display='none'">
                <div>
                    <div class="brand-title">TallyConnect</div>
                    <div class="brand-subtitle">Report Portal</div>
                </div>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link" href="companies.html">üè¢ Companies</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="dashboard.html">üìà Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="outstanding-report.html">üìä Outstanding</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="ledgers.html">üìó Ledger</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sales-register.html">üí∞ Sales Register</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="finance.html">üíº Finance</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sync-logs.html">üìã Sync Logs</a>
            </li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page active">
            <a href="reports.html" class="back-button">‚Üê Back to Reports</a>
            <!-- Filter Toggle Button -->
            <div class="tc-filterbar-header">
                <button type="button" class="tc-filterbar-toggle" id="filterToggleBtn" aria-label="Toggle Filters">
                    <span class="tc-filterbar-toggle__icon">üîΩ</span>
                    <span class="tc-filterbar-toggle__label">FILTERS</span>
                </button>
                <div class="tc-filterbar-summary" id="filterSummary"></div>
            </div>
            
            <!-- Filters Bar (Horizontal) -->
            <div id="filterContainer" class="tc-filterbar-container"></div>
            
            <!-- Dashboard Content -->
            <div class="tc-dashboard-content">
                <div id="reportContent" class="report-viewer">
                        <div class="tc-loading">
                            <div class="spinner" style="margin: 20px auto;"></div>
                            <div class="tc-loading__text">Loading dashboard...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chart.js Library (Open Source) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- JavaScript Files -->
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/export.js"></script>
    <script src="assets/js/utils/filters.js"></script>
    <script src="assets/js/utils/date-filters.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/components/companies.js"></script>
    <script src="assets/js/components/ledgers.js"></script>
    <script src="assets/js/components/dashboard.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        // Global date filter manager
        let dashboardDateFilter = null;
        
        // Load report from sessionStorage (override app.js window.onload)
        window.addEventListener('load', function() {
            const savedCompany = sessionStorage.getItem('selectedCompany');
            if (savedCompany) {
                selectedCompany = JSON.parse(savedCompany);

                // If company name contains FY like "F.Y. 21-22", default dashboard to that FY
                let defaultFYStartYear = null;
                try {
                    const name = (selectedCompany && selectedCompany.name) ? String(selectedCompany.name) : '';
                    const m = name.match(/F\\.?Y\\.?\\s*(\\d{2})\\s*-\\s*(\\d{2})/i);
                    if (m) {
                        const yy = parseInt(m[1], 10);
                        defaultFYStartYear = 2000 + yy; // 21 => 2021
                    }
                } catch (e) {
                    defaultFYStartYear = null;
                }
                
                // Initialize date filter manager (horizontal bar layout)
                dashboardDateFilter = new DateFilterManager({
                    containerId: 'filterContainer',
                    defaultDateRange: 'current_financial_year',
                    defaultYear: defaultFYStartYear,
                    layout: 'bar',
                    onFilterChange: function(filterParams) {
                        // Reload dashboard with new filter parameters
                        reloadDashboardWithFilters(filterParams);
                        // Update filter summary
                        updateFilterSummary(filterParams);
                    }
                });
                dashboardDateFilter.render();
                
                // Initialize filter toggle button
                const filterToggleBtn = document.getElementById('filterToggleBtn');
                const filterContainer = document.getElementById('filterContainer');
                
                if (filterToggleBtn && filterContainer) {
                    // Default to expanded (filters visible)
                    const isCollapsed = localStorage.getItem('dashboardFilterCollapsed') === 'true';
                    
                    // Ensure filter container is visible initially
                    filterContainer.style.display = '';
                    filterContainer.style.visibility = 'visible';
                    filterContainer.style.opacity = '1';
                    
                    if (isCollapsed) {
                        filterContainer.classList.add('tc-filterbar-container--collapsed');
                        filterToggleBtn.classList.add('tc-filterbar-toggle--collapsed');
                    } else {
                        // Make sure it's expanded
                        filterContainer.classList.remove('tc-filterbar-container--collapsed');
                        filterToggleBtn.classList.remove('tc-filterbar-toggle--collapsed');
                    }
                    
                    filterToggleBtn.addEventListener('click', function() {
                        const isCurrentlyCollapsed = filterContainer.classList.contains('tc-filterbar-container--collapsed');
                        if (isCurrentlyCollapsed) {
                            filterContainer.classList.remove('tc-filterbar-container--collapsed');
                            filterToggleBtn.classList.remove('tc-filterbar-toggle--collapsed');
                            localStorage.setItem('dashboardFilterCollapsed', 'false');
                        } else {
                            filterContainer.classList.add('tc-filterbar-container--collapsed');
                            filterToggleBtn.classList.add('tc-filterbar-toggle--collapsed');
                            localStorage.setItem('dashboardFilterCollapsed', 'true');
                        }
                    });
                }
                
                // Update filter summary function
                function updateFilterSummary(params) {
                    const summaryEl = document.getElementById('filterSummary');
                    if (summaryEl && params) {
                        const period = params.dateRange || 'Current FY';
                        const from = params.startDate ? new Date(params.startDate).toISOString().split('T')[0] : '';
                        const to = params.endDate ? new Date(params.endDate).toISOString().split('T')[0] : '';
                        if (from && to) {
                            summaryEl.textContent = `Period: ${period} ‚Ä¢ ${from} ‚Üí ${to}`;
                        } else {
                            summaryEl.textContent = `Period: ${period}`;
                        }
                    }
                }
                
                // Load dashboard with initial filters
                const filterParams = dashboardDateFilter.getFilterParams();
                updateFilterSummary(filterParams);
                loadDashboardReportWithFilters(filterParams);
            } else {
                window.location.href = 'companies.html';
            }
        });
        
        /**
         * Load dashboard with filter parameters
         */
        function loadDashboardReportWithFilters(filterParams) {
            const safeGuid = selectedCompany.guid.replace(/-/g, '_').replace(/\./g, '_');
            const safeAlterid = String(selectedCompany.alterid).replace(/\./g, '_');
            
            // Build API URL with query parameters
            const params = new URLSearchParams();
            if (filterParams.start_date) params.append('start_date', filterParams.start_date);
            if (filterParams.end_date) params.append('end_date', filterParams.end_date);
            if (filterParams.financial_year) params.append('financial_year', filterParams.financial_year);
            
            const queryString = params.toString();
            const apiUrl = `api/dashboard-data/${safeGuid}_${safeAlterid}${queryString ? '?' + queryString : ''}`;
            
            loadDashboardReport(apiUrl, 'reports');
        }
        
        /**
         * Reload dashboard when filters change
         */
        function reloadDashboardWithFilters(filterParams) {
            loadDashboardReportWithFilters(filterParams);
        }
    </script>
</body>
</html>

