<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finance - TallyConnect</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script>
        // IMMEDIATE redirect check - before any content loads
        (function() {
            try {
                const savedCompany = sessionStorage.getItem('selectedCompany');
                if (!savedCompany) {
                    window.location.replace('companies.html');
                }
            } catch (e) {
                window.location.replace('companies.html');
            }
        })();
    </script>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="assets/css/main.css">
    <link rel="stylesheet" href="assets/css/layout.css">
    <link rel="stylesheet" href="assets/css/components.css">
    <link rel="stylesheet" href="assets/css/utilities.css">
    <link rel="stylesheet" href="assets/css/ledger-report.css">
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">
            <div class="brand">
                <img class="brand-logo" src="/logo.png" alt="Logo" onerror="this.style.display='none'">
                <div>
                    <div class="brand-title">TallyConnect</div>
                    <div class="brand-subtitle">Report Portal</div>
                </div>
            </div>
        </div>
        <ul class="nav-menu">
            <li class="nav-item">
                <a class="nav-link" href="companies.html">üè¢ Companies</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="dashboard.html">üìà Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="outstanding-report.html">üìä Outstanding</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="ledgers.html">üìó Ledger</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sales-register.html">üí∞ Sales Register</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="finance.html">üíº Finance</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="sync-logs.html">üìã Sync Logs</a>
            </li>
        </ul>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <div class="page active" id="financePage" style="display: none;">
            <a href="reports.html" class="back-button">‚Üê Back to Reports</a>
            
            <!-- Finance Tabs -->
            <div class="tc-tabs" id="financeTabs">
                <button class="tc-tab tc-tab--active" data-tab="overview">Overview</button>
                <button class="tc-tab" data-tab="trial-balance">Trial Balance</button>
                <button class="tc-tab" data-tab="payable">Payable</button>
                <button class="tc-tab" data-tab="purchase">Purchase</button>
                <button class="tc-tab" data-tab="status">Status</button>
                <button class="tc-tab" data-tab="vendor">Vendor</button>
            </div>

            <!-- Finance Tab Panels -->
            <div class="tc-tab-panels">
                <!-- Overview Tab -->
                <div class="tc-tab-panel tc-tab-panel--active" id="tab-overview">
                    <div class="tc-section">
                        <div class="tc-header-row">
                            <div>
                                <h3 class="tc-section__title">üíº Finance Overview</h3>
                                <div class="tc-section__hint" id="financeCompanyName" style="font-size: 11px; line-height: 1.4;">Comprehensive financial metrics and analysis</div>
                            </div>
                        </div>
                        
                        <!-- Finance KPIs -->
                        <div class="tc-kpi-grid">
                            <div class="tc-kpi tc-kpi--mint">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Revenue</div>
                                    <div class="tc-kpi__icon">üí∞</div>
                                </div>
                                <div class="tc-kpi__value" id="financeRevenue">-</div>
                                <div class="tc-kpi__sub">Total Revenue</div>
                            </div>
                            <div class="tc-kpi tc-kpi--sky">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">COGS</div>
                                    <div class="tc-kpi__icon">üì¶</div>
                                </div>
                                <div class="tc-kpi__value" id="financeCogs">-</div>
                                <div class="tc-kpi__sub">Cost of Goods Sold</div>
                            </div>
                            <div class="tc-kpi tc-kpi--violet">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Gross Profit</div>
                                    <div class="tc-kpi__icon">üè†</div>
                                </div>
                                <div class="tc-kpi__value" id="financeGrossProfit">-</div>
                                <div class="tc-kpi__sub">Revenue - COGS</div>
                            </div>
                            <div class="tc-kpi tc-kpi--rose">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Expenses</div>
                                    <div class="tc-kpi__icon">üí∏</div>
                                </div>
                                <div class="tc-kpi__value" id="financeExpenses">-</div>
                                <div class="tc-kpi__sub">Total Expenses</div>
                            </div>
                            <div class="tc-kpi tc-kpi--amber">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Net Profit</div>
                                    <div class="tc-kpi__icon">üíµ</div>
                                </div>
                                <div class="tc-kpi__value" id="financeNetProfit">-</div>
                                <div class="tc-kpi__sub">Gross Profit - Expenses</div>
                            </div>
                            <div class="tc-kpi tc-kpi--teal">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Profit Margin</div>
                                    <div class="tc-kpi__icon">üìä</div>
                                </div>
                                <div class="tc-kpi__value" id="financeProfitMargin">-</div>
                                <div class="tc-kpi__sub">% of Revenue</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Payable Tab -->
                <div class="tc-tab-panel" id="tab-payable">
                    <div class="tc-section">
                        <h3 class="tc-section__title">üìã Payable Overview</h3>
                        <div class="tc-section__hint">Accounts payable metrics and vendor management</div>
                        
                        <div class="tc-kpi-grid">
                            <div class="tc-kpi tc-kpi--mint">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Total Vendors</div>
                                    <div class="tc-kpi__icon">üìã</div>
                                </div>
                                <div class="tc-kpi__value" id="payableTotalVendors">-</div>
                                <div class="tc-kpi__sub">Vendors</div>
                            </div>
                            <div class="tc-kpi tc-kpi--sky">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Open Vendors</div>
                                    <div class="tc-kpi__icon">üìÇ</div>
                                </div>
                                <div class="tc-kpi__value" id="payableOpenVendors">-</div>
                                <div class="tc-kpi__sub">Active</div>
                            </div>
                            <div class="tc-kpi tc-kpi--violet">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Total Invoices</div>
                                    <div class="tc-kpi__icon">üìÑ</div>
                                </div>
                                <div class="tc-kpi__value" id="payableTotalInvoices">-</div>
                                <div class="tc-kpi__sub">Invoices</div>
                            </div>
                            <div class="tc-kpi tc-kpi--rose">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Open Invoices</div>
                                    <div class="tc-kpi__icon">üìä</div>
                                </div>
                                <div class="tc-kpi__value" id="payableOpenInvoices">-</div>
                                <div class="tc-kpi__sub">Pending</div>
                            </div>
                            <div class="tc-kpi tc-kpi--amber">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Total Amount</div>
                                    <div class="tc-kpi__icon">üí∞</div>
                                </div>
                                <div class="tc-kpi__value" id="payableTotalAmount">-</div>
                                <div class="tc-kpi__sub">Payable</div>
                            </div>
                            <div class="tc-kpi tc-kpi--teal">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Open Amount</div>
                                    <div class="tc-kpi__icon">üí≥</div>
                                </div>
                                <div class="tc-kpi__value" id="payableOpenAmount">-</div>
                                <div class="tc-kpi__sub">Outstanding</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Trial Balance Tab -->
                <div class="tc-tab-panel" id="tab-trial-balance">
                    <div class="tc-section">
                        <div class="tc-header-row">
                            <div>
                                <h3 class="tc-section__title">‚öñÔ∏è Trial Balance</h3>
                                <div class="tc-section__hint">Ledger-wise opening balance, period transactions, and closing balance</div>
                            </div>
                            <div class="tc-actions">
                                <button onclick="exportTrialBalance('csv')" class="tc-btn tc-btn--success">üìÑ CSV</button>
                                <button onclick="exportTrialBalance('excel')" class="tc-btn tc-btn--primary">üìä Excel</button>
                                <button onclick="exportTrialBalance('pdf')" class="tc-btn tc-btn--danger">üìë PDF</button>
                            </div>
                        </div>
                        
                        <!-- Period Filter -->
                        <div id="trialBalanceFilterContainer" class="tc-filterbar-container" style="margin-bottom: 20px;"></div>
                        
                        <!-- Trial Balance Table -->
                        <div class="tc-table-wrap">
                            <table class="tc-table" id="trialBalanceTable">
                                <thead>
                                    <tr>
                                        <th class="tc-left">Primary Group</th>
                                        <th class="tc-left">Sub Group</th>
                                        <th class="tc-left">Ledger Name</th>
                                        <th class="tc-right">Opening Dr</th>
                                        <th class="tc-right">Opening Cr</th>
                                        <th class="tc-right">Period Dr</th>
                                        <th class="tc-right">Period Cr</th>
                                        <th class="tc-right">Closing Dr</th>
                                        <th class="tc-right">Closing Cr</th>
                                    </tr>
                                </thead>
                                <tbody id="trialBalanceTableBody">
                                    <tr>
                                        <td colspan="9" class="tc-center" style="padding: 40px;">
                                            <div class="tc-loading">
                                                <div class="spinner" style="margin: 20px auto;"></div>
                                                <div class="tc-loading__text">Loading trial balance...</div>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                                <tfoot id="trialBalanceTableFoot" style="display: none;">
                                    <tr>
                                        <td colspan="3" class="tc-fw-900">Total</td>
                                        <td class="tc-right tc-fw-900" id="totalOpeningDr">0.00</td>
                                        <td class="tc-right tc-fw-900" id="totalOpeningCr">0.00</td>
                                        <td class="tc-right tc-fw-900" id="totalPeriodDr">0.00</td>
                                        <td class="tc-right tc-fw-900" id="totalPeriodCr">0.00</td>
                                        <td class="tc-right tc-fw-900" id="totalClosingDr">0.00</td>
                                        <td class="tc-right tc-fw-900" id="totalClosingCr">0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Purchase Tab -->
                <div class="tc-tab-panel" id="tab-purchase">
                    <div class="tc-section">
                        <h3 class="tc-section__title">üõí Purchase Invoices</h3>
                        <div class="tc-section__hint">Purchase transactions and vendor analysis</div>
                        
                        <div class="tc-kpi-grid">
                            <div class="tc-kpi tc-kpi--mint">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Vendors</div>
                                    <div class="tc-kpi__icon">üè¢</div>
                                </div>
                                <div class="tc-kpi__value" id="purchaseVendors">-</div>
                                <div class="tc-kpi__sub">Total Vendors</div>
                            </div>
                            <div class="tc-kpi tc-kpi--sky">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Documents</div>
                                    <div class="tc-kpi__icon">üìÑ</div>
                                </div>
                                <div class="tc-kpi__value" id="purchaseDocuments">-</div>
                                <div class="tc-kpi__sub">Purchase Orders</div>
                            </div>
                            <div class="tc-kpi tc-kpi--violet">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Quantity</div>
                                    <div class="tc-kpi__icon">üì¶</div>
                                </div>
                                <div class="tc-kpi__value" id="purchaseQuantity">-</div>
                                <div class="tc-kpi__sub">Total Qty</div>
                            </div>
                            <div class="tc-kpi tc-kpi--rose">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Amount</div>
                                    <div class="tc-kpi__icon">üí∞</div>
                                </div>
                                <div class="tc-kpi__value" id="purchaseAmount">-</div>
                                <div class="tc-kpi__sub">Total Amount</div>
                            </div>
                            <div class="tc-kpi tc-kpi--amber">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Discount</div>
                                    <div class="tc-kpi__icon">üè∑Ô∏è</div>
                                </div>
                                <div class="tc-kpi__value" id="purchaseDiscount">-</div>
                                <div class="tc-kpi__sub">Total Discount</div>
                            </div>
                            <div class="tc-kpi tc-kpi--teal">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">After Discount</div>
                                    <div class="tc-kpi__icon">‚úì</div>
                                </div>
                                <div class="tc-kpi__value" id="purchaseAfterDiscount">-</div>
                                <div class="tc-kpi__sub">Net Amount</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status Tab -->
                <div class="tc-tab-panel" id="tab-status">
                    <div class="tc-section">
                        <h3 class="tc-section__title">‚è∞ Payable Status</h3>
                        <div class="tc-section__hint">Payment status and overdue analysis</div>
                        
                        <div class="tc-kpi-grid">
                            <div class="tc-kpi tc-kpi--mint">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">No of Invoices</div>
                                    <div class="tc-kpi__icon">üìã</div>
                                </div>
                                <div class="tc-kpi__value" id="statusInvoices">-</div>
                                <div class="tc-kpi__sub">Total Invoices</div>
                            </div>
                            <div class="tc-kpi tc-kpi--sky">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Balance Amount</div>
                                    <div class="tc-kpi__icon">üí∞</div>
                                </div>
                                <div class="tc-kpi__value" id="statusBalance">-</div>
                                <div class="tc-kpi__sub">Outstanding</div>
                            </div>
                            <div class="tc-kpi tc-kpi--violet">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Overdue Days</div>
                                    <div class="tc-kpi__icon">‚è∞</div>
                                </div>
                                <div class="tc-kpi__value" id="statusOverdueDays">-</div>
                                <div class="tc-kpi__sub">Avg Days</div>
                            </div>
                            <div class="tc-kpi tc-kpi--rose">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Top Countries</div>
                                    <div class="tc-kpi__icon">üåê</div>
                                </div>
                                <div class="tc-kpi__value" id="statusCountries">-</div>
                                <div class="tc-kpi__sub">Countries</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Vendor Tab -->
                <div class="tc-tab-panel" id="tab-vendor">
                    <div class="tc-section">
                        <h3 class="tc-section__title">üè™ Vendor Statement</h3>
                        <div class="tc-section__hint">Vendor performance and credit analysis</div>
                        
                        <div class="tc-kpi-grid">
                            <div class="tc-kpi tc-kpi--mint">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Credit Limit</div>
                                    <div class="tc-kpi__icon">üí≥</div>
                                </div>
                                <div class="tc-kpi__value" id="vendorCreditLimit">-</div>
                                <div class="tc-kpi__sub">Total Limit</div>
                            </div>
                            <div class="tc-kpi tc-kpi--sky">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Total Purchases</div>
                                    <div class="tc-kpi__icon">üõçÔ∏è</div>
                                </div>
                                <div class="tc-kpi__value" id="vendorPurchases">-</div>
                                <div class="tc-kpi__sub">Transactions</div>
                            </div>
                            <div class="tc-kpi tc-kpi--violet">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Total Payments</div>
                                    <div class="tc-kpi__icon">üí∞</div>
                                </div>
                                <div class="tc-kpi__value" id="vendorPayments">-</div>
                                <div class="tc-kpi__sub">Payments</div>
                            </div>
                            <div class="tc-kpi tc-kpi--rose">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Total Balance</div>
                                    <div class="tc-kpi__icon">üìä</div>
                                </div>
                                <div class="tc-kpi__value" id="vendorBalance">-</div>
                                <div class="tc-kpi__sub">Outstanding</div>
                            </div>
                            <div class="tc-kpi tc-kpi--amber">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Open Invoices</div>
                                    <div class="tc-kpi__icon">üìã</div>
                                </div>
                                <div class="tc-kpi__value" id="vendorOpenInvoices">-</div>
                                <div class="tc-kpi__sub">Pending</div>
                            </div>
                            <div class="tc-kpi tc-kpi--teal">
                                <div class="tc-kpi__top">
                                    <div class="tc-kpi__label">Avg Overdue Days</div>
                                    <div class="tc-kpi__icon">‚è∞</div>
                                </div>
                                <div class="tc-kpi__value" id="vendorOverdueDays">-</div>
                                <div class="tc-kpi__sub">Days</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- JavaScript Files -->
    <script src="assets/js/utils/helpers.js"></script>
    <script src="assets/js/utils/date-filters.js"></script>
    <script src="assets/js/utils/export.js"></script>
    <script src="assets/js/api.js"></script>
    <script src="assets/js/app.js"></script>
    <script>
        // Additional check - redirect if no company (before page loads)
        (function() {
            try {
                const savedCompany = sessionStorage.getItem('selectedCompany');
                if (!savedCompany) {
                    window.location.replace('companies.html');
                }
            } catch (e) {
                window.location.replace('companies.html');
            }
        })();
    </script>
    <script>
        // Load company from sessionStorage and initialize page
        window.addEventListener('load', function() {
            const savedCompany = sessionStorage.getItem('selectedCompany');
            if (savedCompany) {
                try {
                    selectedCompany = JSON.parse(savedCompany);
                    
                    // Show the page content
                    const financePage = document.getElementById('financePage');
                    if (financePage) {
                        financePage.style.display = 'block';
                    }
                    
                    // Display company name in page (compact)
                    const companyName = selectedCompany.name || 'Unknown Company';
                    const companyHint = document.getElementById('financeCompanyName');
                    if (companyHint) {
                        // Truncate long company names
                        const displayName = companyName.length > 40 ? companyName.substring(0, 37) + '...' : companyName;
                        companyHint.innerHTML = `<span style="font-weight: 600; color: var(--text);">${displayName}</span> ‚Ä¢ Comprehensive financial metrics and analysis`;
                    }
                } catch (e) {
                    console.error('Error parsing company data:', e);
                    window.location.href = 'companies.html';
                    return;
                }
            } else {
                // No company selected - redirect to companies page
                window.location.href = 'companies.html';
                return;
            }

            // Finance tabs functionality
            const tabs = document.getElementById('financeTabs');
            const panels = {
                overview: document.getElementById('tab-overview'),
                'trial-balance': document.getElementById('tab-trial-balance'),
                payable: document.getElementById('tab-payable'),
                purchase: document.getElementById('tab-purchase'),
                status: document.getElementById('tab-status'),
                vendor: document.getElementById('tab-vendor'),
            };

            // Trial Balance date filter manager
            let trialBalanceDateFilter = null;

            function setActiveTab(tabKey) {
                if (tabs) {
                    tabs.querySelectorAll('.tc-tab').forEach(b => b.classList.remove('tc-tab--active'));
                    const btn = tabs.querySelector(`.tc-tab[data-tab="${tabKey}"]`);
                    if (btn) btn.classList.add('tc-tab--active');
                }
                Object.values(panels).forEach(p => p && p.classList.remove('tc-tab-panel--active'));
                if (panels[tabKey]) panels[tabKey].classList.add('tc-tab-panel--active');
                
                // Load Trial Balance data when tab is activated
                if (tabKey === 'trial-balance') {
                    if (!trialBalanceDateFilter) {
                        initializeTrialBalanceFilters();
                    }
                    loadTrialBalance();
                }
            }

            if (tabs) {
                tabs.addEventListener('click', (e) => {
                    const btn = e.target && e.target.closest ? e.target.closest('button.tc-tab') : null;
                    if (!btn) return;
                    const tabKey = btn.getAttribute('data-tab');
                    if (!tabKey) return;
                    setActiveTab(tabKey);
                });
            }

            // Initialize Trial Balance date filters
            function initializeTrialBalanceFilters() {
                const container = document.getElementById('trialBalanceFilterContainer');
                if (!container) return;
                
                // Get default financial year from company name if available
                let defaultFYStartYear = null;
                try {
                    const name = (selectedCompany && selectedCompany.name) ? String(selectedCompany.name) : '';
                    const m = name.match(/F\.?Y\.?\s*(\d{2})\s*-\s*(\d{2})/i);
                    if (m) {
                        const yy = parseInt(m[1], 10);
                        defaultFYStartYear = 2000 + yy;
                    }
                } catch (e) {
                    defaultFYStartYear = null;
                }
                
                trialBalanceDateFilter = new DateFilterManager({
                    containerId: 'trialBalanceFilterContainer',
                    defaultDateRange: 'current_financial_year',
                    defaultYear: defaultFYStartYear,
                    layout: 'bar',
                    onFilterChange: function(filterParams) {
                        loadTrialBalance();
                    }
                });
                
                trialBalanceDateFilter.render();
            }

            // Load Trial Balance data
            function loadTrialBalance() {
                if (!selectedCompany) return;
                
                // Initialize filter if not already done
                if (!trialBalanceDateFilter) {
                    initializeTrialBalanceFilters();
                    // Wait a bit for filter to initialize, then load
                    setTimeout(() => loadTrialBalance(), 100);
                    return;
                }
                
                const tbody = document.getElementById('trialBalanceTableBody');
                if (!tbody) return;
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="tc-center" style="padding: 40px;">
                            <div class="tc-loading">
                                <div class="spinner" style="margin: 20px auto;"></div>
                                <div class="tc-loading__text">Loading trial balance...</div>
                            </div>
                        </td>
                    </tr>
                `;
                
                const filterParams = trialBalanceDateFilter.getFilterParams();
                const fromDate = filterParams.start_date || filterParams.from_date;
                const toDate = filterParams.end_date || filterParams.to_date;
                
                if (!fromDate || !toDate) {
                    console.error('Date parameters missing:', filterParams);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="tc-center" style="padding: 40px;">
                                <div class="tc-title-lg" style="margin-bottom: 8px;">Error loading trial balance</div>
                                <div class="tc-subtitle">Date parameters are missing. Please select a period.</div>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                const safeGuid = selectedCompany.guid.replace(/-/g, '_').replace(/\./g, '_');
                const safeAlterid = String(selectedCompany.alterid).replace(/\./g, '_');
                const apiUrl = `api/trial-balance-data/${safeGuid}_${safeAlterid}?from_date=${encodeURIComponent(fromDate)}&to_date=${encodeURIComponent(toDate)}`;
                
                fetch(apiUrl)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        renderTrialBalance(data);
                    })
                    .catch(error => {
                        console.error('Error loading trial balance:', error);
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="9" class="tc-center" style="padding: 40px;">
                                    <div class="tc-title-lg" style="margin-bottom: 8px;">Error loading trial balance</div>
                                    <div class="tc-subtitle">${error.message}</div>
                                </td>
                            </tr>
                        `;
                    });
            }

            // Render Trial Balance table
            function renderTrialBalance(data) {
                const tbody = document.getElementById('trialBalanceTableBody');
                const tfoot = document.getElementById('trialBalanceTableFoot');
                
                if (!tbody) return;
                
                if (!data.trial_balance || data.trial_balance.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="9" class="tc-center" style="padding: 60px;">
                                <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">‚öñÔ∏è</div>
                                <div class="tc-title-lg" style="margin-bottom: 8px;">No Trial Balance Data</div>
                                <div class="tc-subtitle">No ledger transactions found for the selected period.</div>
                            </td>
                        </tr>
                    `;
                    tfoot.style.display = 'none';
                    return;
                }
                
                tbody.innerHTML = '';
                let totalOpeningDr = 0, totalOpeningCr = 0;
                let totalPeriodDr = 0, totalPeriodCr = 0;
                let totalClosingDr = 0, totalClosingCr = 0;
                let currentPrimaryGroup = '';
                let currentSubGroup = '';
                
                data.trial_balance.forEach((row, index) => {
                    const openingDr = parseFloat(row.opening_debit || 0);
                    const openingCr = parseFloat(row.opening_credit || 0);
                    const periodDr = parseFloat(row.period_debit || 0);
                    const periodCr = parseFloat(row.period_credit || 0);
                    const closingDr = parseFloat(row.closing_debit || 0);
                    const closingCr = parseFloat(row.closing_credit || 0);
                    
                    totalOpeningDr += openingDr;
                    totalOpeningCr += openingCr;
                    totalPeriodDr += periodDr;
                    totalPeriodCr += periodCr;
                    totalClosingDr += closingDr;
                    totalClosingCr += closingCr;
                    
                    // Show primary group only when it changes
                    const showPrimaryGroup = row.primary_group !== currentPrimaryGroup;
                    const showSubGroup = row.sub_group !== currentSubGroup || showPrimaryGroup;
                    
                    if (showPrimaryGroup) currentPrimaryGroup = row.primary_group || '';
                    if (showSubGroup) currentSubGroup = row.sub_group || '';
                    
                    const tr = document.createElement('tr');
                    tr.style.animationDelay = `${index * 20}ms`;
                    tr.innerHTML = `
                        <td class="${showPrimaryGroup ? 'tc-fw-700' : 'tc-muted'}" style="${showPrimaryGroup ? 'padding-top: 12px;' : ''}">
                            ${showPrimaryGroup ? (row.primary_group || '-') : ''}
                        </td>
                        <td class="${showSubGroup ? 'tc-fw-600' : 'tc-muted'}" style="${showSubGroup ? 'padding-top: 8px;' : ''}">
                            ${showSubGroup ? (row.sub_group || '-') : ''}
                        </td>
                        <td class="tc-fw-600">${row.ledger_name || '-'}</td>
                        <td class="tc-right">${openingDr > 0 ? formatCurrency(openingDr) : '-'}</td>
                        <td class="tc-right">${openingCr > 0 ? formatCurrency(openingCr) : '-'}</td>
                        <td class="tc-right">${periodDr > 0 ? formatCurrency(periodDr) : '-'}</td>
                        <td class="tc-right">${periodCr > 0 ? formatCurrency(periodCr) : '-'}</td>
                        <td class="tc-right">${closingDr > 0 ? formatCurrency(closingDr) : '-'}</td>
                        <td class="tc-right">${closingCr > 0 ? formatCurrency(closingCr) : '-'}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                // Update totals
                document.getElementById('totalOpeningDr').textContent = formatCurrency(totalOpeningDr);
                document.getElementById('totalOpeningCr').textContent = formatCurrency(totalOpeningCr);
                document.getElementById('totalPeriodDr').textContent = formatCurrency(totalPeriodDr);
                document.getElementById('totalPeriodCr').textContent = formatCurrency(totalPeriodCr);
                document.getElementById('totalClosingDr').textContent = formatCurrency(totalClosingDr);
                document.getElementById('totalClosingCr').textContent = formatCurrency(totalClosingCr);
                
                tfoot.style.display = 'table-footer-group';
                
                // Store data for export
                window.trialBalanceData = data;
            }

            // Export Trial Balance
            function exportTrialBalance(format) {
                if (!window.trialBalanceData) {
                    alert('No trial balance data to export. Please load the report first.');
                    return;
                }
                
                const data = window.trialBalanceData;
                const companyName = data.company_name || 'Company';
                const fromDate = data.from_date || '';
                const toDate = data.to_date || '';
                
                // Prepare export data
                const exportData = [];
                exportData.push(['Primary Group', 'Sub Group', 'Ledger Name', 'Opening Dr', 'Opening Cr', 'Period Dr', 'Period Cr', 'Closing Dr', 'Closing Cr']);
                
                if (data.trial_balance && data.trial_balance.length > 0) {
                    data.trial_balance.forEach(row => {
                        exportData.push([
                            row.primary_group || '',
                            row.sub_group || '',
                            row.ledger_name || '',
                            parseFloat(row.opening_debit || 0),
                            parseFloat(row.opening_credit || 0),
                            parseFloat(row.period_debit || 0),
                            parseFloat(row.period_credit || 0),
                            parseFloat(row.closing_debit || 0),
                            parseFloat(row.closing_credit || 0)
                        ]);
                    });
                    
                    // Add totals row
                    exportData.push([
                        'TOTAL',
                        data.totals.opening_debit || 0,
                        data.totals.opening_credit || 0,
                        data.totals.period_debit || 0,
                        data.totals.period_credit || 0,
                        data.totals.closing_debit || 0,
                        data.totals.closing_credit || 0
                    ]);
                }
                
                const fileName = `Trial_Balance_${companyName.replace(/[^a-zA-Z0-9]/g, '_')}_${fromDate}_to_${toDate}`;
                
                if (format === 'csv') {
                    exportToCSV(exportData, fileName);
                } else if (format === 'excel') {
                    exportToExcel(exportData, fileName, 'Trial Balance');
                } else if (format === 'pdf') {
                    exportToPDF(exportData, fileName, `Trial Balance - ${companyName}`, `Period: ${fromDate} to ${toDate}`);
                }
            }

            // Initialize with Overview tab
            setActiveTab('overview');
        });
    </script>
</body>
</html>

